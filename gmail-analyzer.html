<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Storage Analyzer - Free & Private</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .privacy-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #f0f2ff;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats {
            padding: 20px 30px;
            background: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .view-options {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
        }
        
        .visualization {
            padding: 30px;
            min-height: 600px;
        }
        
        .treemap-container {
            width: 100%;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }
        
        .treemap-block {
            position: absolute;
            border: 2px solid white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            overflow: hidden;
        }
        
        .treemap-block:hover {
            opacity: 0.85;
            z-index: 10;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .block-label {
            color: white;
            font-size: 13px;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            text-align: center;
            word-wrap: break-word;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .block-size {
            color: white;
            font-size: 12px;
            margin-top: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .block-count {
            color: rgba(255,255,255,0.9);
            font-size: 11px;
            margin-top: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .breadcrumb {
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: #999;
        }
        
        .login-container {
            padding: 60px;
            text-align: center;
        }
        
        .login-container h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .login-container p {
            margin-bottom: 30px;
            color: #666;
            line-height: 1.6;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            text-align: left;
        }
        
        .feature-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }
        
        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        
        .progress-container {
            max-width: 500px;
            margin: 20px auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .progress-text {
            color: #666;
            font-size: 14px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .detail-panel {
            position: fixed;
            right: -450px;
            top: 0;
            width: 450px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .detail-panel.open {
            right: 0;
        }
        
        .detail-header {
            padding: 20px;
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .detail-content {
            padding: 20px;
        }
        
        .email-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .email-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }
        
        .email-item.selected {
            background: #f0f2ff;
            border-color: #667eea;
        }
        
        .email-subject {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .email-meta {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        
        .gmail-link {
            display: inline-block;
            margin-top: 8px;
            color: #667eea;
            font-size: 12px;
            text-decoration: none;
            font-weight: 600;
        }
        
        .gmail-link:hover {
            text-decoration: underline;
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .action-buttons {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: white;
            border-top: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .info-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 30px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .info-banner-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .info-banner-text {
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .detail-panel {
                width: 100%;
                right: -100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .view-options {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Gmail Storage Analyzer</h1>
            <p>Free, open-source, and 100% private - runs entirely in your browser</p>
            <div class="privacy-badge">🔒 Your emails never leave your device</div>
        </div>
        
        <div id="loginSection" class="login-container">
            <h2>Visualize Your Gmail Storage</h2>
            <p>See what's taking up space in your Gmail with beautiful treemap visualizations.<br>
            No signup required. No data collection. Completely free.</p>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>🔒 100% Private</h3>
                    <p>Everything runs in your browser. Your emails never touch our servers because we don't have any.</p>
                </div>
                <div class="feature-card">
                    <h3>📊 Visual Analysis</h3>
                    <p>See your storage usage as an interactive treemap, similar to WinDirStat for files.</p>
                </div>
                <div class="feature-card">
                    <h3>🎯 Multiple Views</h3>
                    <p>Group by sender, time period, or email size to find what's hogging space.</p>
                </div>
                <div class="feature-card">
                    <h3>💾 Free Forever</h3>
                    <p>Open source and free. No premium features, no subscriptions, no catches.</p>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="handleSignIn()" style="font-size: 16px; padding: 14px 28px; margin-top: 20px;">
                🔐 Sign in with Google
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                We only request read-only access to analyze your emails.<br>
                You can revoke access anytime in your Google Account settings.
            </p>
        </div>
        
        <div id="mainSection" style="display: none;">
            <div class="info-banner" id="infoBanner" style="display: none;">
                <div class="info-banner-icon">⚠️</div>
                <div class="info-banner-text">
                    <strong>View-Only Mode:</strong> This tool can only analyze your emails. 
                    To delete emails, click "Open in Gmail" on any email to manage it directly in Gmail.
                    This keeps your data secure in your browser.
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="loadEmails()" id="loadBtn">
                    📥 Analyze Emails
                </button>
                <div class="view-options">
                    <button class="view-btn active" onclick="switchView('sender')">👤 By Sender</button>
                    <button class="view-btn" onclick="switchView('time')">📅 By Time</button>
                    <button class="view-btn" onclick="switchView('size')">📏 By Size</button>
                </div>
                <button class="btn btn-secondary" onclick="exportData()">
                    📊 Export CSV
                </button>
                <button class="btn btn-danger" onclick="signOut()" style="margin-left: auto;">
                    🚪 Sign Out
                </button>
            </div>
            
            <div id="statsSection" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmails">0</div>
                    <div class="stat-label">Total Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSize">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="largestSender">-</div>
                    <div class="stat-label">Largest Sender</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgSize">0 KB</div>
                    <div class="stat-label">Avg Email Size</div>
                </div>
            </div>
            
            <div id="breadcrumb" class="breadcrumb" style="display: none;">
                <span class="breadcrumb-item" onclick="navigateToRoot()">All Emails</span>
            </div>
            
            <div class="visualization">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loadingText">Connecting to Gmail...</p>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <div class="progress-text" id="progressText">Preparing...</div>
                    </div>
                </div>
                <div id="treemapContainer" class="treemap-container"></div>
            </div>
        </div>
    </div>
    
    <div id="detailPanel" class="detail-panel">
        <div class="detail-header">
            <button class="close-btn" onclick="closeDetailPanel()">×</button>
            <h3 id="detailTitle">Email Details</h3>
            <p id="detailSubtitle"></p>
        </div>
        <div class="detail-content" id="detailContent"></div>
        <div class="action-buttons">
            <button class="btn btn-primary" style="width: 100%;" onclick="openSelectedInGmail()">
                📧 Open Selected in Gmail (<span id="selectedCount">0</span>)
            </button>
        </div>
    </div>

    <script>
        const CLIENT_ID = '535589785401-2efmknqsh6j6rmr8ch47bnaj39l0n8qc.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
        
        let accessToken = null;
        let tokenClient = null;
        let emailData = [];
        let currentView = 'sender';
        let currentDrilldown = null;
        let selectedEmails = new Set();
        
        // Initialize Google Identity Services
        function initGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('mainSection').style.display = 'block';
                        document.getElementById('infoBanner').style.display = 'flex';
                    }
                },
            });
        }
        
        function handleSignIn() {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
                alert('⚠️ Setup Required:\n\n' +
                      '1. Go to Google Cloud Console (console.cloud.google.com)\n' +
                      '2. Create a new project\n' +
                      '3. Enable Gmail API\n' +
                      '4. Create OAuth 2.0 credentials\n' +
                      '5. Add http://localhost:8000 to authorized origins\n' +
                      '6. Replace CLIENT_ID in the code\n\n' +
                      'For now, showing demo data...');
                
                // Demo mode
                accessToken = 'demo_token';
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'block';
                return;
            }
            
            if (!tokenClient) {
                initGoogleAuth();
            }
            tokenClient.requestAccessToken();
        }
        
        async function loadEmails() {
            if (!accessToken) {
                alert('Please sign in first');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('treemapContainer').innerHTML = '';
            document.getElementById('loadBtn').disabled = true;
            
            if (accessToken === 'demo_token') {
                await loadDemoData();
                return;
            }
            
            try {
                await fetchRealEmails();
            } catch (error) {
                console.error('Error loading emails:', error);
                alert('Error loading emails: ' + error.message + '\n\nLoading demo data instead.');
                await loadDemoData();
            }
        }
        
        async function fetchRealEmails() {
            updateProgress(0, 'Fetching email list...');
            
            // Fetch message IDs
            let allMessages = [];
            let pageToken = null;
            let pageCount = 0;
            const maxPages = 100; // Limit to ~10000 emails for performance
            
            do {
                const url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=100${pageToken ? '&pageToken=' + pageToken : ''}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Gmail API error: ${response.status}`);
                }
                
                const data = await response.json();
                allMessages = allMessages.concat(data.messages || []);
                pageToken = data.nextPageToken;
                pageCount++;
                
                updateProgress(Math.min(20, pageCount * 2), `Found ${allMessages.length} emails...`);
            } while (pageToken && pageCount < maxPages);
            
            updateProgress(25, `Analyzing ${allMessages.length} emails...`);
            
            // Fetch details in batches
            const batchSize = 50;
            emailData = [];
            
            for (let i = 0; i < allMessages.length; i += batchSize) {
                const batch = allMessages.slice(i, i + batchSize);
                const promises = batch.map(msg => fetchEmailDetails(msg.id));
                const results = await Promise.all(promises);
                emailData = emailData.concat(results.filter(r => r !== null));
                
                const progress = 25 + (i / allMessages.length) * 70;
                updateProgress(progress, `Processed ${i + batch.length} of ${allMessages.length} emails...`);
            }
            
            updateProgress(100, 'Analysis complete!');
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
                updateStats();
                renderTreemap();
            }, 500);
        }
        
        async function fetchEmailDetails(messageId) {
            try {
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}?format=metadata&metadataHeaders=From&metadataHeaders=Subject&metadataHeaders=Date`,
                    {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    }
                );
                
                if (!response.ok) return null;
                
                const email = await response.json();
                const headers = email.payload.headers;
                const getHeader = (name) => headers.find(h => h.name === name)?.value || '';
                
                return {
                    id: email.id,
                    sender: getHeader('From').replace(/^.*<(.+)>.*$/, '$1').trim() || getHeader('From'),
                    subject: getHeader('Subject') || '(No Subject)',
                    size: email.sizeEstimate || 0,
                    date: new Date(parseInt(email.internalDate)),
                    snippet: email.snippet || ''
                };
            } catch (error) {
                console.error('Error fetching email:', messageId, error);
                return null;
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = Math.round(percent) + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        async function loadDemoData() {
            updateProgress(0, 'Generating demo data...');
            
            const senders = [
                'notifications@linkedin.com',
                'updates@github.com',
                'newsletter@medium.com',
                'support@amazon.com',
                'no-reply@facebook.com',
                'alerts@twitter.com',
                'team@slack.com',
                'billing@stripe.com',
                'digest@reddit.com',
                'info@dropbox.com',
                'marketing@shopify.com',
                'security@google.com',
                'news@nytimes.com',
                'deals@groupon.com',
                'updates@spotify.com'
            ];
            
            emailData = [];
            for (let i = 0; i < 750; i++) {
                const sender = senders[Math.floor(Math.random() * senders.length)];
                const size = Math.floor(Math.random() * 10000000) + 1000;
                const daysAgo = Math.floor(Math.random() * 730);
                const date = new Date();
                date.setDate(date.getDate() - daysAgo);
                
                emailData.push({
                    id: `demo_${i}`,
                    sender: sender,
                    subject: `Email from ${sender.split('@')[0]} #${i}`,
                    size: size,
                    date: date,
                    snippet: 'This is demo data to show how the visualization works...'
                });
                
                if (i % 100 === 0) {
                    updateProgress((i / 750) * 90, `Generating ${i} of 750 demo emails...`);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            
            updateProgress(100, 'Demo data ready!');
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
                updateStats();
                renderTreemap();
            }, 500);
        }
        
        function updateStats() {
            const totalEmails = emailData.length;
            const totalSize = emailData.reduce((sum, email) => sum + email.size, 0);
            
            const senderGroups = {};
            emailData.forEach(email => {
                if (!senderGroups[email.sender]) {
                    senderGroups[email.sender] = 0;
                }
                senderGroups[email.sender] += email.size;
            });
            
            const largestSender = Object.entries(senderGroups)
                .sort((a, b) => b[1] - a[1])[0];
            
            document.getElementById('totalEmails').textContent = totalEmails.toLocaleString();
            document.getElementById('totalSize').textContent = formatSize(totalSize);
            document.getElementById('largestSender').textContent = largestSender ? 
                largestSender[0].split('@')[0] : '-';
            document.getElementById('avgSize').textContent = formatSize(totalSize / totalEmails);
            
            document.getElementById('statsSection').style.display = 'grid';
        }
        
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }
        
        function switchView(view) {
            currentView = view;
            currentDrilldown = null;
            
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderTreemap();
        }
        
        function renderTreemap() {
            const container = document.getElementById('treemapContainer');
            container.innerHTML = '';
            
            if (emailData.length === 0) return;
            
            let groups = {};
            
            if (currentDrilldown) {
                const emails = currentView === 'sender' 
                    ? emailData.filter(e => e.sender === currentDrilldown)
                    : currentView === 'time'
                    ? emailData.filter(e => getTimeGroup(e.date) === currentDrilldown)
                    : emailData.filter(e => getSizeGroup(e.size) === currentDrilldown);
                
                emails.forEach(email => {
                    groups[email.id] = {
                        size: email.size,
                        label: email.subject.substring(0, 40),
                        data: [email]
                    };
                });
                
                document.getElementById('breadcrumb').style.display = 'flex';
                document.getElementById('breadcrumb').innerHTML = `
                    <span class="breadcrumb-item" onclick="navigateToRoot()">All Emails</span>
                    <span class="breadcrumb-separator">›</span>
                    <span>${currentDrilldown}</span>
                `;
            } else {
                emailData.forEach(email => {
                    let key;
                    if (currentView === 'sender') {
                        key = email.sender;
                    } else if (currentView === 'time') {
                        key = getTimeGroup(email.date);
                    } else {
                        key = getSizeGroup(email.size);
                    }
                    
                    if (!groups[key]) {
                        groups[key] = { size: 0, label: key, data: [] };
                    }
                    groups[key].size += email.size;
                    groups[key].data.push(email);
                });
                
                document.getElementById('breadcrumb').style.display = 'none';
            }
            
            const sortedGroups = Object.entries(groups)
                .sort((a, b) => b[1].size - a[1].size);
            
            const totalSize = sortedGroups.reduce((sum, [_, group]) => sum + group.size, 0);
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#f38181'
            ];
            
            // Squarified treemap algorithm (simplified)
            let blocks = sortedGroups.map(([key, group], index) => ({
                key,
                group,
                area: (group.size / totalSize) * width * height,
                color: colors[index % colors.length]
            }));
            
            let row = [];
            let x = 0, y = 0;
            let rowHeight = 0;
            const containerAspect = width / height;
            
            blocks.forEach((block, i) => {
                const blockWidth = Math.max(100, Math.min(width - x, Math.sqrt(block.area)));
                const blockHeight = Math.max(80, block.area / blockWidth);
                
                if (x + blockWidth > width && row.length > 0) {
                    x = 0;
                    y += rowHeight;
                    rowHeight = 0;
                    row = [];
                }
                
                const blockEl = document.createElement('div');
                blockEl.className = 'treemap-block';
                blockEl.style.left = x + 'px';
                blockEl.style.top = y + 'px';
                blockEl.style.width = blockWidth + 'px';
                blockEl.style.height = blockHeight + 'px';
                blockEl.style.background = block.color;
                
                const truncatedLabel = block.group.label.length > 30 
                    ? block.group.label.substring(0, 27) + '...' 
                    : block.group.label;
                
                blockEl.innerHTML = `
                    <div class="block-label">${truncatedLabel}</div>
                    <div class="block-size">${formatSize(block.group.size)}</div>
                    <div class="block-count">${block.group.data.length} email${block.group.data.length !== 1 ? 's' : ''}</div>
                `;
                
                blockEl.onclick = () => handleBlockClick(block.key, block.group);
                
                container.appendChild(blockEl);
                
                x += blockWidth + 2;
                rowHeight = Math.max(rowHeight, blockHeight);
                row.push(block);
            });
        }
        
        function getTimeGroup(date) {
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 7) return 'Last 7 days';
            if (diffDays < 30) return 'Last 30 days';
            if (diffDays < 90) return 'Last 3 months';
            if (diffDays < 180) return 'Last 6 months';
            if (diffDays < 365) return 'Last year';
            return 'Over 1 year ago';
        }
        
        function getSizeGroup(size) {
            if (size < 100000) return '< 100 KB';
            if (size < 1000000) return '100 KB - 1 MB';
            if (size < 5000000) return '1 MB - 5 MB';
            if (size < 10000000) return '5 MB - 10 MB';
            return '> 10 MB';
        }
        
        function handleBlockClick(key, group) {
            if (currentDrilldown) {
                showEmailDetails(group.data);
            } else {
                currentDrilldown = key;
                renderTreemap();
            }
        }
        
        function navigateToRoot() {
            currentDrilldown = null;
            renderTreemap();
        }
        
        function showEmailDetails(emails) {
            selectedEmails.clear();
            
            const panel = document.getElementById('detailPanel');
            const content = document.getElementById('detailContent');
            const title = document.getElementById('detailTitle');
            const subtitle = document.getElementById('detailSubtitle');
            
            title.textContent = emails.length === 1 ? 'Email Details' : 'Email Group';
            subtitle.textContent = `${emails.length} email(s) - ${formatSize(emails.reduce((s, e) => s + e.size, 0))}`;
            
            content.innerHTML = emails.map(email => `
                <div class="email-item" data-email-id="${email.id}" onclick="toggleEmailSelection('${email.id}')">
                    <div class="email-subject">${escapeHtml(email.subject)}</div>
                    <div class="email-meta">
                        <strong>From:</strong> ${escapeHtml(email.sender)}<br>
                        <strong>Date:</strong> ${email.date.toLocaleDateString()} ${email.date.toLocaleTimeString()}<br>
                        <strong>Size:</strong> ${formatSize(email.size)}
                    </div>
                    <a href="https://mail.google.com/mail/u/0/#inbox/${email.id}" 
                       target="_blank" 
                       class="gmail-link"
                       onclick="event.stopPropagation()">
                        📧 Open in Gmail
                    </a>
                </div>
            `).join('');
            
            panel.classList.add('open');
            updateSelectedCount();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleEmailSelection(emailId) {
            if (selectedEmails.has(emailId)) {
                selectedEmails.delete(emailId);
            } else {
                selectedEmails.add(emailId);
            }
            
            const element = document.querySelector(`[data-email-id="${emailId}"]`);
            if (element) {
                element.classList.toggle('selected');
            }
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedEmails.size;
        }
        
        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('open');
            selectedEmails.clear();
        }
        
        function openSelectedInGmail() {
            if (selectedEmails.size === 0) {
                alert('Please select at least one email');
                return;
            }
            
            const emailIds = Array.from(selectedEmails);
            
            if (emailIds.length === 1) {
                window.open(`https://mail.google.com/mail/u/0/#inbox/${emailIds[0]}`, '_blank');
            } else {
                // Open multiple emails in tabs
                if (confirm(`Open ${emailIds.length} emails in new tabs?`)) {
                    emailIds.forEach((id, index) => {
                        setTimeout(() => {
                            window.open(`https://mail.google.com/mail/u/0/#inbox/${id}`, '_blank');
                        }, index * 200); // Stagger to avoid popup blocker
                    });
                }
            }
        }
        
        function exportData() {
            if (emailData.length === 0) {
                alert('No data to export. Please analyze emails first.');
                return;
            }
            
            const csv = [
                ['Sender', 'Subject', 'Size (bytes)', 'Date', 'Size (human)'].join(','),
                ...emailData.map(email => 
                    [
                        `"${email.sender.replace(/"/g, '""')}"`,
                        `"${email.subject.replace(/"/g, '""')}"`,
                        email.size,
                        email.date.toISOString(),
                        `"${formatSize(email.size)}"`
                    ].join(',')
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gmail_storage_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function signOut() {
            if (confirm('Sign out and clear all data?')) {
                accessToken = null;
                emailData = [];
                currentDrilldown = null;
                selectedEmails.clear();
                
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('mainSection').style.display = 'none';
                document.getElementById('statsSection').style.display = 'none';
                document.getElementById('treemapContainer').innerHTML = '';
                
                // Revoke Google token if not demo
                if (tokenClient && accessToken !== 'demo_token') {
                    google.accounts.oauth2.revoke(accessToken);
                }
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            if (typeof google !== 'undefined') {
                initGoogleAuth();
            }
        });
    </script>
</body>
</html>